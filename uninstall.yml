- hosts: all
  tasks:

  - name: Stop services
    systemd:
      name: "{{ item }}"
      state: stopped
    ignore_errors: true
    loop:
      - kubelet
      - docker
      - cri-docker.service
      - cri-docker.socket

  - name: Reset kubeadm
    command: kubeadm reset -f
    ignore_errors: true

  - name: Remove packages
    apt:
      name:
        - docker.io
        - kubelet
        - kubeadm
        - kubectl
      state: absent
      purge: yes

  - name: Remove directories
    file:
      path: "{{ item }}"
      state: absent
    loop:
      - /etc/kubernetes
      - /var/lib/kubelet
      - /var/lib/etcd
      - /var/lib/docker
      - /opt/cni
      - /etc/systemd/system/cri-docker.service
      - /etc/systemd/system/cri-docker.socket
      - /usr/local/bin/cri-dockerd

  - name: Reload systemd
    systemd:
      daemon_reload: yes
    changed_when: false
